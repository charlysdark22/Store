const Product = require('../models/Product');
const Order = require('../models/Order');
const User = require('../models/User');
const Coupon = require('../models/Coupon');

class ChatbotService {
  constructor() {
    this.intents = new Map();
    this.contexts = new Map();
    this.conversations = new Map();
    this.initializeIntents();
  }

  initializeIntents() {
    // Intenciones y respuestas del chatbot
    this.intents.set('greeting', {
      patterns: [
        'hola', 'hello', 'hi', 'buenos d√≠as', 'buenas tardes', 'buenas noches',
        'hey', 'saludos', 'qu√© tal', 'como estas'
      ],
      responses: {
        es: [
          '¬°Hola! üëã Soy el asistente virtual de Tech Store Cuba. ¬øEn qu√© puedo ayudarte hoy?',
          '¬°Bienvenido a Tech Store! üõí Estoy aqu√≠ para ayudarte con cualquier pregunta.',
          '¬°Hola! Me alegra verte por aqu√≠. ¬øNecesitas ayuda con algo espec√≠fico?'
        ],
        en: [
          'Hello! üëã I\'m Tech Store Cuba\'s virtual assistant. How can I help you today?',
          'Welcome to Tech Store! üõí I\'m here to help with any questions.',
          'Hi! Great to see you here. Do you need help with something specific?'
        ]
      },
      followUp: ['products', 'orders', 'support']
    });

    this.intents.set('products', {
      patterns: [
        'productos', 'products', 'cat√°logo', 'catalog', 'computadoras', 'laptops',
        'tel√©fonos', 'phones', 'accesorios', 'accessories', 'qu√© venden', 'what do you sell'
      ],
      responses: {
        es: [
          'üì±üíª Tenemos una gran variedad de productos tecnol√≥gicos:',
          'üõí Nuestro cat√°logo incluye:'
        ],
        en: [
          'üì±üíª We have a great variety of tech products:',
          'üõí Our catalog includes:'
        ]
      },
      action: 'showProductCategories'
    });

    this.intents.set('orders', {
      patterns: [
        'pedido', 'order', 'compra', 'purchase', 'seguimiento', 'tracking',
        'estado', 'status', 'd√≥nde est√°', 'where is', 'cu√°ndo llega', 'when arrives'
      ],
      responses: {
        es: [
          'üì¶ Te puedo ayudar con informaci√≥n sobre tu pedido.',
          'üöö Para consultar el estado de tu pedido, necesito algunos datos.'
        ],
        en: [
          'üì¶ I can help you with information about your order.',
          'üöö To check your order status, I need some information.'
        ]
      },
      action: 'handleOrderInquiry',
      requiresAuth: true
    });

    this.intents.set('payment', {
      patterns: [
        'pago', 'payment', 'transferm√≥vil', 'enzona', 'como pagar', 'how to pay',
        'm√©todos de pago', 'payment methods', 'bancos', 'banks'
      ],
      responses: {
        es: [
          'üí≥ Aceptamos varios m√©todos de pago seguros en Cuba:',
          'üè¶ Puedes pagar con:'
        ],
        en: [
          'üí≥ We accept several secure payment methods in Cuba:',
          'üè¶ You can pay with:'
        ]
      },
      action: 'showPaymentMethods'
    });

    this.intents.set('shipping', {
      patterns: [
        'env√≠o', 'shipping', 'entrega', 'delivery', 'costo de env√≠o', 'shipping cost',
        'cu√°nto demora', 'how long', 'gratis', 'free'
      ],
      responses: {
        es: [
          'üöö Informaci√≥n sobre env√≠os:',
          'üìç Enviamos a toda Cuba:'
        ],
        en: [
          'üöö Shipping information:',
          'üìç We ship all over Cuba:'
        ]
      },
      action: 'showShippingInfo'
    });

    this.intents.set('support', {
      patterns: [
        'ayuda', 'help', 'soporte', 'support', 'problema', 'problem',
        'contacto', 'contact', 'tel√©fono', 'phone', 'email'
      ],
      responses: {
        es: [
          'üÜò Estoy aqu√≠ para ayudarte. Tambi√©n puedes contactar a nuestro equipo:',
          'üìû Opciones de contacto:'
        ],
        en: [
          'üÜò I\'m here to help. You can also contact our team:',
          'üìû Contact options:'
        ]
      },
      action: 'showSupportOptions'
    });

    this.intents.set('search', {
      patterns: [
        'buscar', 'search', 'encontrar', 'find', 'necesito', 'i need',
        'quiero', 'i want', 'recomienda', 'recommend'
      ],
      responses: {
        es: [
          'üîç Te ayudo a encontrar lo que buscas.',
          'üéØ ¬øQu√© tipo de producto necesitas?'
        ],
        en: [
          'üîç I\'ll help you find what you\'re looking for.',
          'üéØ What type of product do you need?'
        ]
      },
      action: 'handleProductSearch',
      requiresInput: true
    });

    this.intents.set('price', {
      patterns: [
        'precio', 'price', 'costo', 'cost', 'cu√°nto cuesta', 'how much',
        'barato', 'cheap', 'caro', 'expensive', 'oferta', 'offer'
      ],
      responses: {
        es: [
          'üí∞ Te ayudo con informaci√≥n de precios.',
          'üè∑Ô∏è ¬øSobre qu√© producto quieres saber el precio?'
        ],
        en: [
          'üí∞ I\'ll help with pricing information.',
          'üè∑Ô∏è Which product would you like to know the price of?'
        ]
      },
      action: 'handlePriceInquiry',
      requiresInput: true
    });

    this.intents.set('goodbye', {
      patterns: [
        'adi√≥s', 'goodbye', 'bye', 'hasta luego', 'see you later',
        'gracias', 'thank you', 'thanks', 'chao', 'nos vemos'
      ],
      responses: {
        es: [
          '¬°Hasta pronto! üëã Gracias por visitar Tech Store Cuba.',
          '¬°Que tengas un excelente d√≠a! üåü Vuelve cuando quieras.',
          '¬°Adi√≥s! Espero haberte ayudado. ¬°Vuelve pronto! üòä'
        ],
        en: [
          'See you soon! üëã Thanks for visiting Tech Store Cuba.',
          'Have a great day! üåü Come back anytime.',
          'Goodbye! Hope I was helpful. Come back soon! üòä'
        ]
      }
    });

    this.intents.set('unknown', {
      responses: {
        es: [
          'ü§î No estoy seguro de entender. ¬øPodr√≠as ser m√°s espec√≠fico?',
          '‚ùì Disculpa, no entend√≠ bien. ¬øPuedes reformular tu pregunta?',
          'üÜò No reconozco esa consulta. Te puedo ayudar con: productos, pedidos, pagos, env√≠os o soporte.'
        ],
        en: [
          'ü§î I\'m not sure I understand. Could you be more specific?',
          '‚ùì Sorry, I didn\'t understand well. Can you rephrase your question?',
          'üÜò I don\'t recognize that query. I can help with: products, orders, payments, shipping or support.'
        ]
      },
      followUp: ['products', 'orders', 'payment', 'shipping', 'support']
    });
  }

  // Procesar mensaje del usuario
  async processMessage(message, userId = null, language = 'es') {
    try {
      const sessionId = userId || 'anonymous';
      const normalizedMessage = message.toLowerCase().trim();
      
      // Obtener o crear contexto de conversaci√≥n
      let context = this.contexts.get(sessionId) || {
        language,
        previousIntent: null,
        waitingFor: null,
        conversationHistory: []
      };

      // Agregar mensaje al historial
      context.conversationHistory.push({
        type: 'user',
        message: message,
        timestamp: new Date()
      });

      // Detectar intenci√≥n
      const intent = this.detectIntent(normalizedMessage);
      
      // Generar respuesta
      const response = await this.generateResponse(intent, normalizedMessage, context, userId);
      
      // Agregar respuesta al historial
      context.conversationHistory.push({
        type: 'bot',
        message: response.text,
        timestamp: new Date(),
        intent: intent,
        data: response.data
      });

      // Actualizar contexto
      context.previousIntent = intent;
      this.contexts.set(sessionId, context);

      return {
        success: true,
        response: response.text,
        intent,
        data: response.data,
        quickReplies: response.quickReplies,
        requiresAuth: response.requiresAuth
      };

    } catch (error) {
      console.error('Chatbot processing error:', error);
      return {
        success: false,
        response: language === 'es' ? 
          'Lo siento, ocurri√≥ un error. ¬øPuedes intentar de nuevo?' :
          'Sorry, an error occurred. Can you try again?',
        intent: 'error'
      };
    }
  }

  // Detectar intenci√≥n del mensaje
  detectIntent(message) {
    let bestMatch = { intent: 'unknown', confidence: 0 };

    for (const [intentName, intentData] of this.intents.entries()) {
      if (!intentData.patterns) continue;

      for (const pattern of intentData.patterns) {
        const confidence = this.calculateSimilarity(message, pattern);
        if (confidence > bestMatch.confidence && confidence > 0.6) {
          bestMatch = { intent: intentName, confidence };
        }
      }
    }

    return bestMatch.intent;
  }

  // Calcular similitud entre textos
  calculateSimilarity(text1, text2) {
    const words1 = text1.toLowerCase().split(/\s+/);
    const words2 = text2.toLowerCase().split(/\s+/);
    
    let matches = 0;
    for (const word1 of words1) {
      for (const word2 of words2) {
        if (word1.includes(word2) || word2.includes(word1)) {
          matches++;
          break;
        }
      }
    }
    
    return matches / Math.max(words1.length, words2.length);
  }

  // Generar respuesta basada en intenci√≥n
  async generateResponse(intent, message, context, userId) {
    const intentData = this.intents.get(intent);
    const language = context.language || 'es';
    
    let response = {
      text: '',
      data: null,
      quickReplies: [],
      requiresAuth: intentData?.requiresAuth || false
    };

    // Verificar autenticaci√≥n si es requerida
    if (intentData?.requiresAuth && !userId) {
      response.text = language === 'es' ?
        'Para ayudarte con eso, necesitas iniciar sesi√≥n primero. üîê' :
        'To help you with that, you need to log in first. üîê';
      response.requiresAuth = true;
      return response;
    }

    // Obtener respuesta base
    if (intentData?.responses?.[language]) {
      const responses = intentData.responses[language];
      response.text = responses[Math.floor(Math.random() * responses.length)];
    }

    // Ejecutar acci√≥n espec√≠fica si existe
    if (intentData?.action) {
      const actionResult = await this.executeAction(
        intentData.action, 
        message, 
        context, 
        userId, 
        language
      );
      
      if (actionResult.text) {
        response.text += '\n\n' + actionResult.text;
      }
      
      response.data = actionResult.data;
      response.quickReplies = actionResult.quickReplies || [];
    }

    // Agregar quick replies de seguimiento
    if (intentData?.followUp) {
      const followUpReplies = intentData.followUp.map(followUp => ({
        title: this.getQuickReplyTitle(followUp, language),
        payload: followUp
      }));
      response.quickReplies = [...response.quickReplies, ...followUpReplies];
    }

    return response;
  }

  // Ejecutar acciones espec√≠ficas
  async executeAction(action, message, context, userId, language) {
    switch (action) {
      case 'showProductCategories':
        return await this.showProductCategories(language);
      
      case 'handleOrderInquiry':
        return await this.handleOrderInquiry(userId, language);
      
      case 'showPaymentMethods':
        return this.showPaymentMethods(language);
      
      case 'showShippingInfo':
        return this.showShippingInfo(language);
      
      case 'showSupportOptions':
        return this.showSupportOptions(language);
      
      case 'handleProductSearch':
        return await this.handleProductSearch(message, language);
      
      case 'handlePriceInquiry':
        return await this.handlePriceInquiry(message, language);
      
      default:
        return { text: '', data: null, quickReplies: [] };
    }
  }

  // Mostrar categor√≠as de productos
  async showProductCategories(language) {
    try {
      const categories = await Product.aggregate([
        { $match: { isActive: true } },
        { 
          $group: { 
            _id: '$category', 
            count: { $sum: 1 },
            avgPrice: { $avg: '$price' }
          } 
        },
        { $sort: { count: -1 } }
      ]);

      const categoryNames = {
        es: {
          desktop: 'üíª Computadoras de Escritorio',
          laptop: 'üíª Laptops',
          phone: 'üì± Tel√©fonos',
          accessories: 'üîå Accesorios'
        },
        en: {
          desktop: 'üíª Desktop Computers',
          laptop: 'üíª Laptops',
          phone: 'üì± Phones',
          accessories: 'üîå Accessories'
        }
      };

      let text = '';
      const quickReplies = [];

      categories.forEach(cat => {
        const name = categoryNames[language][cat._id] || cat._id;
        text += `\n${name} (${cat.count} productos)`;
        quickReplies.push({
          title: name.split(' ')[1], // Solo el nombre sin emoji
          payload: `category_${cat._id}`
        });
      });

      return {
        text,
        data: { categories },
        quickReplies
      };

    } catch (error) {
      return {
        text: language === 'es' ? 
          'Error al cargar categor√≠as.' : 
          'Error loading categories.',
        data: null,
        quickReplies: []
      };
    }
  }

  // Manejar consultas de pedidos
  async handleOrderInquiry(userId, language) {
    try {
      const recentOrders = await Order.find({ user: userId })
        .sort({ createdAt: -1 })
        .limit(3)
        .populate('items.product', 'name');

      if (recentOrders.length === 0) {
        return {
          text: language === 'es' ?
            'No tienes pedidos recientes. ¬°Explora nuestros productos!' :
            'You don\'t have recent orders. Explore our products!',
          data: null,
          quickReplies: [
            { title: language === 'es' ? 'Ver Productos' : 'View Products', payload: 'products' }
          ]
        };
      }

      let text = language === 'es' ? 
        'Estos son tus pedidos recientes:' :
        'These are your recent orders:';

      const quickReplies = [];

      recentOrders.forEach((order, index) => {
        const statusText = {
          es: {
            pending: '‚è≥ Pendiente',
            confirmed: '‚úÖ Confirmado',
            processing: 'üì¶ Procesando',
            shipped: 'üöö Enviado',
            delivered: '‚úÖ Entregado',
            cancelled: '‚ùå Cancelado'
          },
          en: {
            pending: '‚è≥ Pending',
            confirmed: '‚úÖ Confirmed',
            processing: 'üì¶ Processing',
            shipped: 'üöö Shipped',
            delivered: '‚úÖ Delivered',
            cancelled: '‚ùå Cancelled'
          }
        };

        text += `\n\nüìã #${order.orderNumber}`;
        text += `\n${statusText[language][order.status]}`;
        text += `\nüí∞ ${order.total} CUP`;

        if (index < 2) {
          quickReplies.push({
            title: `#${order.orderNumber}`,
            payload: `order_${order._id}`
          });
        }
      });

      return {
        text,
        data: { orders: recentOrders },
        quickReplies
      };

    } catch (error) {
      return {
        text: language === 'es' ?
          'Error al consultar pedidos.' :
          'Error checking orders.',
        data: null,
        quickReplies: []
      };
    }
  }

  // Mostrar m√©todos de pago
  showPaymentMethods(language) {
    const text = language === 'es' ?
      `üí≥ **Transferm√≥vil** - BANDEC, BPA, Metropolitano
üí≥ **EnZona** - BANDEC, BPA, Metropolitano
üíµ **Efectivo** - Pago contraentrega

üîí Todos los pagos son seguros y en CUP (pesos cubanos).` :
      `üí≥ **Transferm√≥vil** - BANDEC, BPA, Metropolitano
üí≥ **EnZona** - BANDEC, BPA, Metropolitano
üíµ **Cash** - Cash on delivery

üîí All payments are secure and in CUP (Cuban pesos).`;

    return {
      text,
      data: {
        methods: ['transfermovil', 'enzona', 'cash'],
        banks: ['bandec', 'bpa', 'metropolitano']
      },
      quickReplies: [
        { 
          title: language === 'es' ? 'Ver Productos' : 'View Products', 
          payload: 'products' 
        }
      ]
    };
  }

  // Mostrar informaci√≥n de env√≠o
  showShippingInfo(language) {
    const text = language === 'es' ?
      `üöö **Env√≠o a toda Cuba**
üìç Todas las provincias
‚è±Ô∏è 2-5 d√≠as h√°biles
üí∞ Env√≠o GRATIS en compras >1000 CUP
üì¶ Empaque seguro garantizado

üèÉ‚Äç‚ôÇÔ∏è **Entrega r√°pida en La Habana**: 24-48 horas` :
      `üöö **Shipping all over Cuba**
üìç All provinces
‚è±Ô∏è 2-5 business days
üí∞ FREE shipping on purchases >1000 CUP
üì¶ Secure packaging guaranteed

üèÉ‚Äç‚ôÇÔ∏è **Fast delivery in Havana**: 24-48 hours`;

    return {
      text,
      data: {
        freeShippingThreshold: 1000,
        deliveryTime: '2-5 days',
        fastDeliveryAreas: ['havana']
      },
      quickReplies: [
        { 
          title: language === 'es' ? 'Ver Productos' : 'View Products', 
          payload: 'products' 
        }
      ]
    };
  }

  // Mostrar opciones de soporte
  showSupportOptions(language) {
    const text = language === 'es' ?
      `üìû **WhatsApp**: +53 5555-5555
üìß **Email**: soporte@techstorecuba.com
üïí **Horario**: Lun-Vie 9:00-18:00

üí¨ Tambi√©n puedes seguir chateando conmigo para:
‚Ä¢ Consultar productos
‚Ä¢ Estado de pedidos  
‚Ä¢ Informaci√≥n de pagos
‚Ä¢ Dudas generales` :
      `üìû **WhatsApp**: +53 5555-5555
üìß **Email**: soporte@techstorecuba.com
üïí **Hours**: Mon-Fri 9:00-18:00

üí¨ You can also keep chatting with me for:
‚Ä¢ Product inquiries
‚Ä¢ Order status
‚Ä¢ Payment information  
‚Ä¢ General questions`;

    return {
      text,
      data: {
        whatsapp: '+53 5555-5555',
        email: 'soporte@techstorecuba.com',
        hours: 'Mon-Fri 9:00-18:00'
      },
      quickReplies: [
        { title: 'WhatsApp', payload: 'whatsapp_contact' },
        { 
          title: language === 'es' ? 'Productos' : 'Products', 
          payload: 'products' 
        }
      ]
    };
  }

  // Manejar b√∫squeda de productos
  async handleProductSearch(message, language) {
    try {
      // Extraer t√©rminos de b√∫squeda del mensaje
      const searchTerms = this.extractSearchTerms(message);
      
      if (!searchTerms) {
        return {
          text: language === 'es' ?
            'üîç ¬øQu√© tipo de producto buscas? Por ejemplo: "laptop gaming", "iPhone", "mouse inal√°mbrico"' :
            'üîç What type of product are you looking for? For example: "gaming laptop", "iPhone", "wireless mouse"',
          data: null,
          quickReplies: [
            { title: 'Laptops', payload: 'category_laptop' },
            { title: language === 'es' ? 'Tel√©fonos' : 'Phones', payload: 'category_phone' },
            { title: language === 'es' ? 'Computadoras' : 'Computers', payload: 'category_desktop' }
          ]
        };
      }

      const products = await Product.find({
        isActive: true,
        $or: [
          { 'name.es': new RegExp(searchTerms, 'i') },
          { 'name.en': new RegExp(searchTerms, 'i') },
          { brand: new RegExp(searchTerms, 'i') },
          { model: new RegExp(searchTerms, 'i') }
        ]
      }).limit(5);

      if (products.length === 0) {
        return {
          text: language === 'es' ?
            `üòî No encontr√© productos con "${searchTerms}". ¬øQuieres ver nuestras categor√≠as?` :
            `üòî I didn't find products with "${searchTerms}". Want to see our categories?`,
          data: null,
          quickReplies: [
            { title: language === 'es' ? 'Ver Categor√≠as' : 'View Categories', payload: 'products' }
          ]
        };
      }

      let text = language === 'es' ?
        `üéØ Encontr√© ${products.length} productos para "${searchTerms}":` :
        `üéØ I found ${products.length} products for "${searchTerms}":`;

      const quickReplies = [];

      products.forEach((product, index) => {
        text += `\n\nüì± ${product.name.es}`;
        text += `\nüí∞ ${product.price} CUP`;
        text += `\n‚≠ê ${product.averageRating || 0}/5`;

        if (index < 3) {
          quickReplies.push({
            title: product.name.es.substring(0, 20),
            payload: `product_${product._id}`
          });
        }
      });

      return {
        text,
        data: { products, searchTerms },
        quickReplies
      };

    } catch (error) {
      return {
        text: language === 'es' ?
          'Error en la b√∫squeda. Intenta de nuevo.' :
          'Search error. Try again.',
        data: null,
        quickReplies: []
      };
    }
  }

  // Manejar consultas de precios
  async handlePriceInquiry(message, language) {
    const searchTerms = this.extractSearchTerms(message);
    
    if (!searchTerms) {
      return {
        text: language === 'es' ?
          'üí∞ ¬øDe qu√© producto quieres saber el precio?' :
          'üí∞ Which product would you like to know the price of?',
        data: null,
        quickReplies: [
          { title: 'iPhone', payload: 'price_iphone' },
          { title: 'MacBook', payload: 'price_macbook' },
          { title: 'Samsung', payload: 'price_samsung' }
        ]
      };
    }

    // Reutilizar l√≥gica de b√∫squeda pero enfocada en precios
    return await this.handleProductSearch(message, language);
  }

  // Extraer t√©rminos de b√∫squeda del mensaje
  extractSearchTerms(message) {
    // Remover palabras comunes
    const stopWords = [
      'busco', 'necesito', 'quiero', 'precio', 'costo', 'cu√°nto',
      'search', 'need', 'want', 'price', 'cost', 'how much',
      'de', 'del', 'la', 'el', 'un', 'una', 'for', 'the', 'a', 'an'
    ];

    const words = message.toLowerCase().split(/\s+/)
      .filter(word => word.length > 2 && !stopWords.includes(word));

    return words.length > 0 ? words.join(' ') : null;
  }

  // Obtener t√≠tulo de quick reply
  getQuickReplyTitle(followUp, language) {
    const titles = {
      es: {
        products: 'üì± Productos',
        orders: 'üì¶ Pedidos',
        payment: 'üí≥ Pagos',
        shipping: 'üöö Env√≠o',
        support: 'üÜò Soporte'
      },
      en: {
        products: 'üì± Products',
        orders: 'üì¶ Orders',
        payment: 'üí≥ Payment',
        shipping: 'üöö Shipping',
        support: 'üÜò Support'
      }
    };

    return titles[language][followUp] || followUp;
  }

  // Obtener historial de conversaci√≥n
  getConversationHistory(userId) {
    const context = this.contexts.get(userId);
    return context?.conversationHistory || [];
  }

  // Limpiar contexto de usuario
  clearUserContext(userId) {
    this.contexts.delete(userId);
    return true;
  }

  // Obtener estad√≠sticas del chatbot
  getStats() {
    const totalConversations = this.contexts.size;
    const intentsCount = {};

    for (const context of this.contexts.values()) {
      for (const message of context.conversationHistory) {
        if (message.type === 'bot' && message.intent) {
          intentsCount[message.intent] = (intentsCount[message.intent] || 0) + 1;
        }
      }
    }

    return {
      totalConversations,
      intentsCount,
      totalIntents: this.intents.size
    };
  }
}

module.exports = new ChatbotService();